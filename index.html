<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Recompensas (Multi-Familia)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Firebase -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            getDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            where,
            getDocs,
            Timestamp,
            writeBatch,
            serverTimestamp,
            orderBy,
            limit,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraci√≥n de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDBzsAiJQ6ktFWUxYSpWDXsWdBwMoW3bNo",
            authDomain: "app-recompensas-familias.firebaseapp.com",
            projectId: "app-recompensas-familias",
            storageBucket: "app-recompensas-familias.firebasestorage.app",
            messagingSenderId: "680945319622",
            appId: "1:680945319622:web:782abbf670e7899b1961c7",
            measurementId: "G-EPPYQC4FGQ"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'multi-family-reward-app';
        
        // --- C√ìDIGO PIN (Default) ---
        const DEFAULT_PIN = '0000'; 

        // *** HELPER FECHAS ***
        function getLocalDateString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); 
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; 
        }

        // --- Inicializaci√≥n ---
        let app, db, auth, provider;
        let currentUserId = null; 
        
        let familyDocRef; 
        let childrenRef, tasksRef, pendingTasksRef, rewardsRef, penaltiesRef, pointsHistoryRef, redeemedRewardsRef, tasksCooldownRef;

        let localUserMode = 'unknown'; 
        let currentChildId = null; 
        let currentChildName = ""; 
        let localAdminPin = DEFAULT_PIN; // PIN actual en memoria
        
        let localChildren = [];
        let localTasks = [];
        let localPendingTasks = [];
        let localTasksCooldown = []; 
        let localRewards = [];
        let localPenalties = [];
        let localPointsHistory = [];
        let localTotalPoints = 0; 
        let localLastReset = null; 
        let localFamilyTasks = []; 

        let currentEditingTaskId = null;
        let currentEditingPenaltyId = null;
        let currentEditingRewardId = null; 
        let currentEditingChildId = null; 
        
        // Variables para edici√≥n global
        let isEditingGlobal = false;
        let editingGlobalOriginalName = "";

        let hasInitialDataLoaded = false; 

        // --- Elementos del DOM ---
        let pages = {};
        let buttons = {};
        let containers = {};
        let forms = {};
        let elements = {};
        let selects = {};

        // --- Listeners ---
        let childrenListener = null;
        let tasksListener = null;
        let pendingTasksListener = null;
        let tasksCooldownListener = null; 
        let rewardsListener = null;
        let penaltiesListener = null;
        let pointsHistoryListener = null;
        let redeemedRewardsListener = null;
        let familyDocListener = null;
        let allTasksListener = null; 

        document.addEventListener('DOMContentLoaded', async () => {
            cacheDOMElements();
            setupUIListeners();
            showLoading(true);

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                provider = new GoogleAuthProvider();

                setupAuthListener(); 

            } catch (error) {
                console.error("Error cr√≠tico en la inicializaci√≥n:", error);
                showPage('page-login'); 
            } finally {
                // showLoading(false); // Se maneja en AuthListener
            }
        });

        function cacheDOMElements() {
            pages = {
                'page-login': document.getElementById('page-login'),
                'page-pin-modal': document.getElementById('page-pin-modal'),
                'page-change-pin-modal': document.getElementById('page-change-pin-modal'), 
                'page-main': document.getElementById('page-main'),
                'page-tasks': document.getElementById('page-tasks'),
                'page-points': document.getElementById('page-points'),
                'page-evaluate': document.getElementById('page-evaluate'),
                'page-redeem': document.getElementById('page-redeem'),
                'page-redeemed-list': document.getElementById('page-redeemed-list'),
                'page-penalties': document.getElementById('page-penalties'),
                'page-manage-children': document.getElementById('page-manage-children'),
                'page-manage-tasks': document.getElementById('page-manage-tasks')
            };
            
            buttons = {
                'btn-login-google': document.getElementById('btn-login-google'),
                'btn-show-email-login': document.getElementById('btn-show-email-login'),
                'btn-show-email-register': document.getElementById('btn-show-email-register'),
                'btn-logout': document.getElementById('btn-logout'),
                'btn-change-pin': document.getElementById('btn-change-pin'), 
                'btn-pin-validate': document.getElementById('btn-pin-validate'),
                'btn-pin-cancel': document.getElementById('btn-pin-cancel'),
                'btn-change-pin-cancel': document.getElementById('btn-change-pin-cancel'), 
                'btn-tasks': document.getElementById('btn-tasks'),
                'btn-points': document.getElementById('btn-points'),
                'btn-evaluate': document.getElementById('btn-evaluate'),
                'btn-redeem': document.getElementById('btn-redeem'),
                'btn-redeemed-list': document.getElementById('btn-redeemed-list'),
                'btn-penalties': document.getElementById('btn-penalties'),
                'btn-manage-children': document.getElementById('btn-manage-children'),
                'btn-manage-tasks': document.getElementById('btn-manage-tasks'),
                'btn-exit-child-mode': document.getElementById('btn-exit-child-mode'),
                'btn-save-global-tasks': document.getElementById('btn-save-global-tasks'),
                'btn-cancel-edit-global-task': document.getElementById('btn-cancel-edit-global-task'),
                back: document.querySelectorAll('.btn-back')
            };

            containers = {
                childLoginList: document.getElementById('child-login-list'),
                tasksList: document.getElementById('tasks-list-container'),
                pendingTasksList: document.getElementById('pending-tasks-list-container'),
                activeTasksEditList: document.getElementById('active-tasks-edit-list-container'),
                rewardsList: document.getElementById('rewards-list-container'),
                rewardsEditList: document.getElementById('rewards-edit-list-container'), 
                redeemedRewardsList: document.getElementById('redeemed-rewards-list-container'),
                penaltiesApplyList: document.getElementById('penalties-apply-list-container'),
                penaltiesEditList: document.getElementById('penalties-edit-list-container'),
                childrenEditList: document.getElementById('children-edit-list-container'),
                taskAssignmentCheckboxes: document.getElementById('task-assignment-checkboxes'), 
                globalTasksSummary: document.getElementById('global-tasks-summary'), 
                pointsHistoryList: document.getElementById('points-history-list')
            };

            forms = {
                'form-email-login': document.getElementById('form-email-login'),
                'form-email-register': document.getElementById('form-email-register'),
                'form-pin': document.getElementById('form-pin'),
                'form-change-pin': document.getElementById('form-change-pin'), 
                'form-add-child': document.getElementById('form-add-child'),
                'form-edit-child': document.getElementById('form-edit-child'),
                'form-add-task': document.getElementById('form-add-task'),
                'form-add-reward': document.getElementById('form-add-reward'),
                'form-edit-reward': document.getElementById('form-edit-reward'), 
                'form-add-penalty': document.getElementById('form-add-penalty'),
                'form-edit-penalty': document.getElementById('form-edit-penalty')
            };

            elements = {
                loginError: document.getElementById('login-error'),
                registerError: document.getElementById('register-error'),
                totalPointsDisplay: document.getElementById('total-points-display'),
                totalPointsHeader: document.getElementById('total-points-header'),
                childNameHeader: document.getElementById('child-name-header'),
                loading: document.getElementById('loading-overlay'),
                pinInput: document.getElementById('pin-input'),
                pinError: document.getElementById('pin-error'),
                
                newPinInput: document.getElementById('new-pin-input'), 
                confirmPinInput: document.getElementById('confirm-pin-input'), 
                changePinError: document.getElementById('change-pin-error'), 

                editChildName: document.getElementById('edit-child-name'),
                editChildGender: document.getElementById('edit-child-gender'),
                editChildCancel: document.getElementById('btn-edit-child-cancel'),
                
                // Elementos del form de tareas global
                addTaskTitle: document.getElementById('add-task-title'),
                addTaskSubmitBtn: document.getElementById('add-task-submit-btn'),
                editTaskCancelContainer: document.getElementById('edit-task-cancel-container'),
                taskNameInput: document.getElementById('task-name'),
                taskPointsInput: document.getElementById('task-points'),

                editPenaltyName: document.getElementById('edit-penalty-name'),
                editPenaltyPoints: document.getElementById('edit-penalty-points'),
                editPenaltyCancel: document.getElementById('btn-edit-penalty-cancel'),
                
                editRewardName: document.getElementById('edit-reward-name'), 
                editRewardCost: document.getElementById('edit-reward-cost'), 
                editRewardCancel: document.getElementById('btn-edit-reward-cancel') 
            };

            selects = {
                'child-select-evaluate': document.getElementById('child-select-evaluate'),
                'child-select-penalties': document.getElementById('child-select-penalties')
            };
        }

        function setupUIListeners() {
            // Login / Register
            buttons['btn-login-google'].addEventListener('click', handleGoogleLogin);
            buttons['btn-show-email-login'].addEventListener('click', () => showLoginForm('login'));
            buttons['btn-show-email-register'].addEventListener('click', () => showLoginForm('register'));
            forms['form-email-login'].addEventListener('submit', handleEmailLogin);
            forms['form-email-register'].addEventListener('submit', handleEmailRegister);
            
            // Navegaci√≥n principal
            buttons['btn-logout'].addEventListener('click', logout);
            buttons['btn-change-pin'].addEventListener('click', () => showPage('page-change-pin-modal')); 
            buttons['btn-tasks'].addEventListener('click', () => showPage('page-tasks'));
            buttons['btn-points'].addEventListener('click', () => showPage('page-points'));
            buttons['btn-evaluate'].addEventListener('click', () => showPage('page-evaluate'));
            buttons['btn-redeem'].addEventListener('click', () => showPage('page-redeem'));
            buttons['btn-redeemed-list'].addEventListener('click', () => showPage('page-redeemed-list'));
            buttons['btn-penalties'].addEventListener('click', () => showPage('page-penalties'));
            buttons['btn-manage-children'].addEventListener('click', () => showPage('page-manage-children'));
            buttons['btn-manage-tasks'].addEventListener('click', () => showPage('page-manage-tasks'));
            
            buttons.back.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (localUserMode === 'admin') {
                        clearAdminSelects();
                        resetGlobalTaskForm(); // Limpiar form al salir
                    }
                    showPage('page-main');
                });
            });

            // PIN Modal (Entrada)
            forms['form-pin'].addEventListener('submit', handlePinValidate);
            buttons['btn-pin-cancel'].addEventListener('click', () => showPage('page-main'));

            // PIN Modal (Cambio)
            forms['form-change-pin'].addEventListener('submit', handleChangePinSubmit);
            buttons['btn-change-pin-cancel'].addEventListener('click', () => {
                forms['form-change-pin'].reset();
                showPage('page-main');
            });

            // Listener para el nuevo bot√≥n de "Salir a Admin" (Candado)
            buttons['btn-exit-child-mode'].addEventListener('click', handleShowPinModal);


            // Forms Admin
            forms['form-add-child'].addEventListener('submit', handleAddChild);
            forms['form-edit-child'].addEventListener('submit', handleEditChildSubmit);
            elements.editChildCancel.addEventListener('click', cancelEditChild);
            
            // Form de Tareas (Global)
            forms['form-add-task'].addEventListener('submit', handleAddOrUpdateTask);
            buttons['btn-save-global-tasks'].addEventListener('click', handleSaveGlobalTasks); 
            buttons['btn-cancel-edit-global-task'].addEventListener('click', resetGlobalTaskForm);

            forms['form-add-reward'].addEventListener('submit', handleAddReward);
            forms['form-edit-reward'].addEventListener('submit', handleEditRewardSubmit); 
            elements.editRewardCancel.addEventListener('click', cancelEditReward); 
            forms['form-add-penalty'].addEventListener('submit', handleAddPenalty);
            forms['form-edit-penalty'].addEventListener('submit', handleEditPenaltySubmit);
            elements.editPenaltyCancel.addEventListener('click', cancelEditPenalty);

            // Selects
            selects['child-select-evaluate'].addEventListener('change', (e) => setupAdminPageContext(e.target.value, 'evaluate'));
            selects['child-select-penalties'].addEventListener('change', (e) => setupAdminPageContext(e.target.value, 'penalties'));
        }

        // --- L√≥gica de Autenticaci√≥n ---

        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    setupGlobalFirestoreReferences(user.uid);
                    setupGlobalFirestoreListeners(); 

                    const savedMode = localStorage.getItem('app_user_mode');
                    const savedChildId = localStorage.getItem('app_child_id');

                    if (savedMode === 'child' && savedChildId) {
                        setChildMode(savedChildId, "Cargando...", 0, "girl"); 
                    } else {
                        setAdminMode(user.uid);
                    }
                } else {
                    currentUserId = null;
                    clearAllListeners();
                    localStorage.removeItem('app_user_mode'); 
                    localStorage.removeItem('app_child_id');
                    showPage('page-login');
                    showLoading(false);
                }
            });
        }
        
        async function handleGoogleLogin() {
            showLoading(true);
            clearLoginErrors();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error en login con Google:", error);
                elements.loginError.textContent = `Error: ${error.message}`;
                elements.loginError.classList.remove('hidden');
                showLoading(false);
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            showLoading(true);
            clearLoginErrors();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error en login con Email:", error);
                elements.loginError.textContent = `Error: ${error.message}`;
                elements.loginError.classList.remove('hidden');
                showLoading(false);
            }
        }
        
        async function handleEmailRegister(e) {
            e.preventDefault();
            showLoading(true);
            clearLoginErrors();
            const email = e.target.email.value;
            const password = e.target.password.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error en registro con Email:", error);
                elements.registerError.textContent = `Error: ${error.message}`;
                elements.registerError.classList.remove('hidden');
                showLoading(false);
            }
        }

        async function logout() {
            showLoading(true);
            clearAllData(); 
            localStorage.clear(); 
            await signOut(auth);
        }

        function showLoginForm(mode) {
            clearLoginErrors();
            if (mode === 'login') {
                forms['form-email-login'].classList.remove('hidden');
                forms['form-email-register'].classList.add('hidden');
                buttons['btn-show-email-login'].classList.add('hidden');
                buttons['btn-show-email-register'].classList.remove('hidden');
            } else {
                forms['form-email-login'].classList.add('hidden');
                forms['form-email-register'].classList.remove('hidden');
                buttons['btn-show-email-login'].classList.remove('hidden');
                buttons['btn-show-email-register'].classList.add('hidden');
            }
        }

        function clearLoginErrors() {
            elements.loginError.classList.add('hidden');
            elements.registerError.classList.add('hidden');
        }

        // --- L√≥gica de Modo Admin / Hijo ---

        function setAdminMode(adminUserId) {
            localUserMode = 'admin';
            currentUserId = adminUserId; 
            
            localStorage.setItem('app_user_mode', 'admin');
            localStorage.removeItem('app_child_id');

            clearChildContext(); 

            updateAdminUI('admin');
            
            populateAdminSelects(); 
            renderChildCheckboxes(); 
            renderAllTasksSummary(); 
            
            showPage('page-main');
            showLoading(false);
        }

        function setChildMode(childId, childName, points, gender) {
            localUserMode = 'child';
            currentChildId = childId;
            currentChildName = childName;
            localTotalPoints = points;
            
            localStorage.setItem('app_user_mode', 'child');
            localStorage.setItem('app_child_id', childId);

            setupChildFirestoreReferences(childId);
            setupChildFirestoreListeners();
            updateAdminUI('child');
            updatePointsDisplay();
            
            const genderEmoji = gender === 'boy' ? 'üë¶' : 'üëß';
            elements.childNameHeader.textContent = `Hola, ${childName}! ${genderEmoji}`;
            showPage('page-main');
            showLoading(false);
        }

        function handleShowPinModal() {
            elements.pinInput.value = '';
            elements.pinError.classList.add('hidden');
            showPage('page-pin-modal');
        }

        function handlePinValidate(e) {
            e.preventDefault();
            const pin = elements.pinInput.value;
            // Validamos contra el PIN local (que viene de la DB)
            if (pin === localAdminPin) { 
                elements.pinInput.value = '';
                elements.pinError.classList.add('hidden');
                setAdminMode(currentUserId); 
            } else {
                elements.pinError.classList.remove('hidden');
            }
        }

        async function handleChangePinSubmit(e) {
            e.preventDefault();
            const newPin = elements.newPinInput.value;
            const confirmPin = elements.confirmPinInput.value;
            
            if (newPin.length !== 4 || isNaN(newPin)) {
                elements.changePinError.textContent = "El PIN debe ser de 4 d√≠gitos.";
                elements.changePinError.classList.remove('hidden');
                return;
            }

            if (newPin !== confirmPin) {
                elements.changePinError.textContent = "Los PINs no coinciden.";
                elements.changePinError.classList.remove('hidden');
                return;
            }

            showLoading(true);
            try {
                await setDoc(familyDocRef, { pin: newPin }, { merge: true });
                localAdminPin = newPin; 
                
                forms['form-change-pin'].reset();
                elements.changePinError.classList.add('hidden');
                showPage('page-main');
                alert("PIN actualizado correctamente.");
            } catch (err) {
                console.error("Error al cambiar PIN:", err);
                elements.changePinError.textContent = "Error al guardar. Intenta de nuevo.";
                elements.changePinError.classList.remove('hidden');
            } finally {
                showLoading(false);
            }
        }

        function updateAdminUI(mode) {
            const adminElements = document.querySelectorAll('.admin-only');
            const childElements = document.querySelectorAll('.child-only');
            
            if (mode === 'child') {
                adminElements.forEach(el => el.classList.add('hidden'));
                childElements.forEach(el => el.classList.remove('hidden'));
                buttons['btn-logout'].classList.add('hidden'); 
            } else if (mode === 'admin') {
                adminElements.forEach(el => el.classList.remove('hidden'));
                childElements.forEach(el => el.classList.add('hidden'));
                buttons['btn-logout'].classList.remove('hidden'); 
            } else {
                adminElements.forEach(el => el.classList.add('hidden'));
                childElements.forEach(el => el.classList.add('hidden'));
                buttons['btn-logout'].classList.add('hidden');
            }
        }

        // --- L√≥gica de Reinicio Diario ---
        async function checkDailyReset() {
            if (!familyDocRef) return;
            const today = getLocalDateString(); 
            
            if (localLastReset && localLastReset !== today) {
                showLoading(true);
                try {
                    const batch = writeBatch(db);
                    
                    for (const child of localChildren) {
                        const childPendingTasksQuery = query(pendingTasksRef, where("childId", "==", child.id));
                        const pendingSnapshot = await getDocs(childPendingTasksQuery);
                        pendingSnapshot.docs.forEach(d => batch.delete(d.ref));
                    }

                    const yesterdayStr = localLastReset; 
                    const cooldownQuery = query(tasksCooldownRef, where("date", "==", yesterdayStr));
                    const cooldownSnapshot = await getDocs(cooldownQuery);
                    cooldownSnapshot.docs.forEach(d => batch.delete(d.ref));
                    
                    batch.set(familyDocRef, { lastReset: today }, { merge: true });
                    await batch.commit();
                    localLastReset = today; 
                } catch (err) {
                    console.error("Error durante el reseteo diario:", err);
                } finally {
                    showLoading(false);
                }
            }
        }

        // --- Limpieza de Estado ---
        function clearAllData() {
            localUserMode = 'unknown';
            currentUserId = null;
            currentChildId = null;
            currentChildName = "";
            localAdminPin = DEFAULT_PIN; 
            localChildren = [];
            localTasks = [];
            localPendingTasks = [];
            localTasksCooldown = []; 
            localRewards = [];
            localPenalties = [];
            localPointsHistory = [];
            localTotalPoints = 0;
            localLastReset = null;
            hasInitialDataLoaded = false;
            localFamilyTasks = []; 
            isEditingGlobal = false;
            editingGlobalOriginalName = "";
        }

        function clearAllListeners() {
            if (familyDocListener) familyDocListener();
            if (childrenListener) childrenListener();
            if (rewardsListener) rewardsListener();
            if (penaltiesListener) penaltiesListener();
            if (redeemedRewardsListener) redeemedRewardsListener();
            if (allTasksListener) allTasksListener(); 
            clearChildContext();
        }

        function clearChildContext() {
            currentChildId = null;
            currentChildName = "";
            localTotalPoints = 0;
            localTasks = [];
            localPendingTasks = [];
            localPointsHistory = [];
            localTasksCooldown = []; 
            
            if(tasksListener) tasksListener();
            if(pendingTasksListener) pendingTasksListener();
            if(pointsHistoryListener) pointsHistoryListener();
            if(tasksCooldownListener) tasksCooldownListener(); 
            tasksListener = null;
            pendingTasksListener = null;
            pointsHistoryListener = null;
            tasksCooldownListener = null; 

            renderTasksList();
            renderPendingTasksList();
            renderPointsHistory();
        }
        
        function clearAdminSelects() {
             Object.values(selects).forEach(select => {
                 if (select) select.value = "";
             });
             clearChildContext(); 
        }

        function showPage(pageId) {
            if (pages[pageId]) {
                 Object.values(pages).forEach(page => {
                     if (page) page.classList.add('hidden');
                 });
                 pages[pageId].classList.remove('hidden');
            } else {
                 console.warn(`P√°gina no encontrada: ${pageId}`);
            }
        }

        function showLoading(isLoading) {
            if (elements.loading) {
                if (isLoading) elements.loading.classList.remove('hidden');
                else elements.loading.classList.add('hidden');
            }
        }

        
        // --- L√≥gica de Admin ---
        function populateAdminSelects() {
            const selectsToPopulate = [
                selects['child-select-evaluate'],
                selects['child-select-penalties']
            ];
            
            selectsToPopulate.forEach(select => {
                if (!select) return;
                const currentValue = select.value; 
                select.innerHTML = '<option value="">Selecciona un hijo...</option>'; 
                localChildren.forEach(child => {
                    const option = document.createElement('option');
                    option.value = child.id;
                    option.textContent = child.name;
                    select.appendChild(option);
                });
                select.value = currentValue; 
            });
        }

        // *** CHECKBOXES ***
        function renderChildCheckboxes(assignedChildIds = []) {
            if (!containers.taskAssignmentCheckboxes) return;
            containers.taskAssignmentCheckboxes.innerHTML = '';
            
            if (localChildren.length === 0) {
                containers.taskAssignmentCheckboxes.innerHTML = '<p class="text-gray-500 text-sm">No tienes hijos registrados.</p>';
                return;
            }

            localChildren.forEach(child => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-blue-50';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'child-assign';
                checkbox.value = child.id;
                checkbox.className = 'w-5 h-5 text-blue-600 rounded focus:ring-blue-500';
                // Si estamos en modo edici√≥n, marcar los que ya la tienen
                if (assignedChildIds.includes(child.id)) {
                    checkbox.checked = true;
                }
                
                const span = document.createElement('span');
                span.textContent = child.name;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                containers.taskAssignmentCheckboxes.appendChild(label);
            });
        }

        // *** RESUMEN GLOBAL DE TAREAS (CON ICONOS) ***
        function renderAllTasksSummary() {
            if (!containers.globalTasksSummary) return;
            containers.globalTasksSummary.innerHTML = '';
            
            if (localFamilyTasks.length === 0) {
                containers.globalTasksSummary.innerHTML = '<p class="text-gray-500 text-sm">No hay tareas creadas.</p>';
                return;
            }

            const grouped = {};
            localFamilyTasks.forEach(task => {
                const key = task.name.trim().toLowerCase(); 
                if (!grouped[key]) {
                    grouped[key] = {
                        originalName: task.name,
                        points: task.points,
                        assignedChildIds: [] 
                    };
                }
                grouped[key].assignedChildIds.push(task.childId);
            });

            Object.values(grouped).forEach(group => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200 mb-3 global-task-card';
                card.dataset.taskName = group.originalName;
                card.dataset.points = group.points;
                
                let checkboxesHTML = '';
                let assignedCount = 0;

                localChildren.forEach(child => {
                    // childId puede ser null si es un placeholder. Si child.id est√° en la lista, es asignado.
                    const isAssigned = group.assignedChildIds.includes(child.id);
                    const genderEmoji = child.gender === 'boy' ? 'üë¶' : 'üëß';
                    if (isAssigned) assignedCount++;
                    
                    checkboxesHTML += `
                        <label class="inline-flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border cursor-pointer hover:bg-gray-100">
                            <input type="checkbox" 
                                   class="task-child-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500" 
                                   value="${child.id}" 
                                   ${isAssigned ? 'checked' : ''}
                                   data-task-name="${group.originalName}"
                            >
                            <span class="text-sm">${genderEmoji} ${child.name}</span>
                        </label>
                    `;
                });

                // Texto de asignaci√≥n
                let statusText = "";
                if (assignedCount === 0) {
                     statusText = '<span class="text-xs text-orange-500 font-medium ml-2">Sin asignar (Plantilla)</span>';
                }

                card.innerHTML = `
                    <div class="mb-2 border-b pb-2 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg inline-block">${group.originalName}</h3>
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full ml-2">${group.points} pts</span>
                            ${statusText}
                        </div>
                        <div class="flex gap-2">
                            <button class="btn-edit-global bg-blue-100 p-2 rounded-full text-blue-600 hover:bg-blue-200" title="Editar Tarea">‚úèÔ∏è</button>
                            <button class="btn-delete-global bg-red-100 p-2 rounded-full text-red-600 hover:bg-red-200" title="Eliminar Tarea">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${checkboxesHTML}
                    </div>
                `;
                
                // Listeners para los botones
                card.querySelector('.btn-edit-global').addEventListener('click', () => startEditGlobalTask(group.originalName, group.points, group.assignedChildIds));
                card.querySelector('.btn-delete-global').addEventListener('click', () => deleteGlobalTask(group.originalName));

                containers.globalTasksSummary.appendChild(card);
            });
            
            if (Object.keys(grouped).length > 0) {
                buttons['btn-save-global-tasks'].classList.remove('hidden');
            } else {
                buttons['btn-save-global-tasks'].classList.add('hidden');
            }
        }

        // --- L√ìGICA DE EDICI√ìN GLOBAL ---

        function startEditGlobalTask(name, points, assignedChildIds) {
            isEditingGlobal = true;
            editingGlobalOriginalName = name;
            
            // Poblar formulario
            elements.addTaskTitle.textContent = `Editando: ${name}`;
            elements.taskNameInput.value = name;
            elements.taskPointsInput.value = points;
            elements.addTaskSubmitBtn.textContent = "Actualizar Tarea";
            elements.addTaskSubmitBtn.classList.replace('bg-blue-500', 'bg-green-500');
            
            // Mostrar bot√≥n cancelar
            elements.editTaskCancelContainer.classList.remove('hidden');
            
            // Renderizar checkboxes con los asignados (incluyendo nulos si se desea, pero aqu√≠ mostramos hijos reales)
            // Filtramos los nulls de assignedChildIds antes de pasar
            const validAssignedIds = assignedChildIds.filter(id => id !== null);
            renderChildCheckboxes(validAssignedIds);
            
            // Scroll hacia arriba suavemente
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetGlobalTaskForm() {
            isEditingGlobal = false;
            editingGlobalOriginalName = "";
            
            forms['form-add-task'].reset();
            
            elements.addTaskTitle.textContent = "Crear Nueva Tarea";
            elements.addTaskSubmitBtn.textContent = "Crear y Asignar";
            elements.addTaskSubmitBtn.classList.replace('bg-green-500', 'bg-blue-500');
            elements.editTaskCancelContainer.classList.add('hidden');
            
            renderChildCheckboxes(); // Limpiar selecci√≥n
        }

        async function handleAddOrUpdateTask(e) {
            e.preventDefault();
            if (!tasksRef) return;

            const name = elements.taskNameInput.value.trim();
            const points = parseInt(elements.taskPointsInput.value, 10);
            
            const checkboxes = document.querySelectorAll('#task-assignment-checkboxes input[type="checkbox"]:checked');
            const selectedChildIds = Array.from(checkboxes).map(cb => cb.value);

            if (!name || points <= 0) {
                alert("Nombre o puntos inv√°lidos.");
                return;
            }
            
            // MODIFICACI√ìN: Permitir 0 seleccionados (crear placeholder)

            showLoading(true);
            const batch = writeBatch(db);

            try {
                if (isEditingGlobal) {
                    // === MODO ACTUALIZAR ===
                    const tasksToUpdate = localFamilyTasks.filter(t => t.name.trim().toLowerCase() === editingGlobalOriginalName.trim().toLowerCase());
                    const existingChildIds = tasksToUpdate.map(t => t.childId);

                    // Borrar existentes que ya no est√°n
                    tasksToUpdate.forEach(task => {
                        if (task.childId && !selectedChildIds.includes(task.childId)) {
                            batch.delete(doc(db, tasksRef.path, task.id));
                        }
                         // Si hay placeholders previos, borrarlos tambi√©n para limpiar
                        if (!task.childId) {
                             batch.delete(doc(db, tasksRef.path, task.id));
                        }
                    });

                    // Crear/Actualizar
                    if (selectedChildIds.length === 0) {
                         // Crear placeholder
                         const newRef = doc(tasksRef);
                         batch.set(newRef, { name: name, points: points, childId: null });
                    } else {
                        selectedChildIds.forEach(childId => {
                             // Si ya exist√≠a para este ni√±o, actualizar (buscar el ID del doc)
                             const existingTask = tasksToUpdate.find(t => t.childId === childId);
                             if (existingTask) {
                                 const taskRef = doc(db, tasksRef.path, existingTask.id);
                                 batch.update(taskRef, { name: name, points: points });
                             } else {
                                 const newTaskRef = doc(tasksRef);
                                 batch.set(newTaskRef, { name: name, points: points, childId: childId });
                             }
                        });
                    }

                    console.log("Actualizando tarea global:", editingGlobalOriginalName);

                } else {
                    // === MODO CREAR ===
                    if (selectedChildIds.length === 0) {
                        // Crear placeholder
                        const newTaskRef = doc(tasksRef);
                        batch.set(newTaskRef, { name, points, childId: null });
                    } else {
                        selectedChildIds.forEach(childId => {
                            const newTaskRef = doc(tasksRef);
                            batch.set(newTaskRef, { name, points, childId });
                        });
                    }
                    console.log("Creando nueva tarea global");
                }

                await batch.commit();
                resetGlobalTaskForm(); 
                
            } catch (err) {
                console.error("Error al guardar/actualizar tarea:", err);
                alert("Error al guardar.");
            } finally {
                showLoading(false);
            }
        }

        async function deleteGlobalTask(originalName) {
            if (!confirm(`¬øSeguro que quieres eliminar la tarea "${originalName}" para TODOS los hijos?`)) return;

            showLoading(true);
            try {
                const batch = writeBatch(db);
                // Buscar todas las tareas con ese nombre
                const tasksToDelete = localFamilyTasks.filter(t => t.name.trim().toLowerCase() === originalName.trim().toLowerCase());
                
                tasksToDelete.forEach(task => {
                    batch.delete(doc(db, tasksRef.path, task.id));
                });

                await batch.commit();
            } catch (err) {
                console.error("Error al eliminar tarea global:", err);
                alert("Error al eliminar.");
            } finally {
                showLoading(false);
            }
        }
        
        // Guardar cambios SOLO de checkboxes (el bot√≥n de abajo)
        async function handleSaveGlobalTasks() {
            showLoading(true);
            try {
                const batch = writeBatch(db);
                const taskCards = document.querySelectorAll('.global-task-card');
                
                for (const card of taskCards) {
                    const taskName = card.dataset.taskName;
                    const points = parseInt(card.dataset.points, 10);
                    
                    const checkboxes = card.querySelectorAll('.task-child-checkbox');
                    const selectedChildIds = [];
                    checkboxes.forEach(cb => { if (cb.checked) selectedChildIds.push(cb.value); });
                    
                    const existingTasks = localFamilyTasks.filter(t => t.name.trim().toLowerCase() === taskName.trim().toLowerCase());
                    const existingChildIds = existingTasks.map(t => t.childId);
                    
                    if (selectedChildIds.length === 0) {
                        // CASO: Ning√∫n ni√±o seleccionado -> Crear/Mantener placeholder (childId: null)
                        
                        // 1. Borrar todas las asignaciones reales
                        existingTasks.forEach(task => {
                            if (task.childId) { // Si tiene un ID real, b√≥rralo
                                batch.delete(doc(db, tasksRef.path, task.id));
                            }
                        });
                        
                        // 2. Asegurar que existe un placeholder
                        const hasPlaceholder = existingTasks.some(t => !t.childId); // childId es null o vac√≠o
                        if (!hasPlaceholder) {
                            const newRef = doc(tasksRef);
                            batch.set(newRef, { name: taskName, points: points, childId: null });
                        }
                        
                    } else {
                        // CASO: Hay ni√±os seleccionados -> Crear asignaciones y borrar placeholders
                        
                        // 1. Crear nuevas asignaciones
                        selectedChildIds.forEach(childId => {
                            if (!existingChildIds.includes(childId)) {
                                const newRef = doc(tasksRef);
                                batch.set(newRef, { name: taskName, points: points, childId: childId });
                            }
                        });
                        
                        // 2. Borrar asignaciones desmarcadas O placeholders
                        existingTasks.forEach(task => {
                            // Si es un placeholder (no tiene childId) O si tiene childId pero no est√° seleccionado
                            if (!task.childId || !selectedChildIds.includes(task.childId)) {
                                batch.delete(doc(db, tasksRef.path, task.id));
                            }
                        });
                    }
                }
                
                await batch.commit();
                alert('Asignaciones actualizadas.');
                
            } catch (err) {
                console.error("Error al guardar cambios globales:", err);
            } finally {
                showLoading(false);
            }
        }

        function setupAdminPageContext(childId, pageKey) {
            clearChildContext(); 
            
            if (!childId) {
                return; 
            }
            const child = localChildren.find(c => c.id === childId);
            if (!child) return;

            currentChildId = childId;
            currentChildName = child.name;
            localTotalPoints = child.totalPoints;

            setupChildFirestoreReferences(childId);
            setupChildFirestoreListeners(); 
            
            // FIX: Actualizar lista de penalidades porque depende de currentChildId
            if (pageKey === 'penalties') {
                renderPenaltiesApplyList();
            }
        }


        // --- Renderizado ---
        function renderChildLoginList() {
            if (!containers.childLoginList) return;
            containers.childLoginList.innerHTML = '';
            localChildren.sort((a,b) => a.name.localeCompare(b.name));
            
            localChildren.forEach(child => {
                const genderEmoji = child.gender === 'boy' ? 'üë¶' : 'üëß';
                const btn = document.createElement('button');
                btn.className = "w-full bg-green-500 text-white p-6 rounded-2xl shadow-lg flex flex-col items-center gap-2 hover:bg-green-600 transition-colors";
                btn.innerHTML = `
                    <span class="text-5xl">${genderEmoji}</span>
                    <span class="text-2xl font-bold">${child.name}</span>
                `;
                btn.addEventListener('click', () => setChildMode(child.id, child.name, child.totalPoints, child.gender));
                containers.childLoginList.appendChild(btn);
            });
        }

        function renderChildrenEditList() {
            if (!containers.childrenEditList) return;
            containers.childrenEditList.innerHTML = '';
            localChildren.forEach(child => {
                const genderEmoji = child.gender === 'boy' ? 'üë¶' : 'üëß';
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg shadow flex justify-between items-center border border-gray-200';
                el.innerHTML = `
                    <span class="font-semibold text-gray-800">${genderEmoji} ${child.name}</span>
                    <div class="flex gap-1">
                        <button class="btn-edit-child text-xl p-2 rounded-full hover:bg-blue-100" data-id="${child.id}">‚úèÔ∏è</button>
                        <button class="btn-delete-child text-xl p-2 rounded-full hover:bg-red-100" data-id="${child.id}">üóëÔ∏è</button>
                    </div>
                `;
                el.querySelector('.btn-edit-child').addEventListener('click', () => startEditChild(child.id, child.name, child.gender));
                el.querySelector('.btn-delete-child').addEventListener('click', () => handleDeleteChild(child.id, child.name));
                containers.childrenEditList.appendChild(el);
            });
        }

        function renderTasksList() {
            if (!containers.tasksList) return;
            containers.tasksList.innerHTML = '';
            if (!currentChildId) return; 
            
            if (localTasks.length === 0) {
                containers.tasksList.innerHTML = '<p class="text-gray-500 text-center">No hay tareas asignadas.</p>';
                return;
            }
            localTasks.sort((a, b) => a.name.localeCompare(b.name));

            let tasksRendered = 0; 

            localTasks.forEach(task => {
                const isPending = localPendingTasks.some(pt => pt.taskId === task.id);
                const isOnCooldown = localTasksCooldown.some(ct => ct.taskId === task.id);

                if (isOnCooldown) {
                    return; 
                }

                tasksRendered++; 

                const taskEl = document.createElement('div');
                taskEl.className = `p-4 rounded-lg shadow flex justify-between items-center ${isPending ? 'bg-gray-200' : 'bg-white'}`;
                taskEl.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg ${isPending ? 'text-gray-500 line-through' : 'text-gray-800'}">${task.name}</span>
                        <span class="text-sm ${isPending ? 'text-gray-400' : 'text-gray-500'}">(${task.points} pts)</span>
                    </div>
                    <button class="btn-complete-task text-3xl p-2 rounded-full transition-transform duration-200 ${isPending ? 'opacity-50 cursor-not-allowed' : 'hover:scale-125'}" data-id="${task.id}" ${isPending ? 'disabled' : ''}>
                        ${isPending ? '‚è≥' : '‚úÖ'}
                    </button>
                `;
                if (!isPending) {
                    taskEl.querySelector('.btn-complete-task').addEventListener('click', (e) => {
                        e.currentTarget.disabled = true;
                        e.currentTarget.innerHTML = '‚è≥';
                        handleCompleteTask(task.id, task.name, task.points);
                    });
                }
                containers.tasksList.appendChild(taskEl);
            });

            if (localTasks.length > 0 && tasksRendered === 0) {
                 containers.tasksList.innerHTML = '<p class="text-gray-500 text-center">¬°Genial! Ya completaste todas tus tareas de hoy.</p>';
                 return;
            }
        }
        
        function renderPendingTasksList() {
            if (!containers.pendingTasksList) return;
            containers.pendingTasksList.innerHTML = '';
            if (!currentChildId) {
                containers.pendingTasksList.innerHTML = '<p class="text-gray-500 text-center">Selecciona un hijo para ver sus tareas pendientes.</p>';
                return;
            }
            if (localPendingTasks.length === 0) {
                containers.pendingTasksList.innerHTML = '<p class="text-gray-500 text-center">No hay tareas pendientes.</p>';
                return;
            }
            localPendingTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'bg-white p-4 rounded-lg shadow space-y-2';
                taskEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-gray-800">${task.name} <span class="text-sm text-gray-500">(${task.points} pts)</span></span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn-approve-task bg-green-500 text-white w-full py-2 px-4 rounded-full font-bold hover:bg-green-600 transition-colors" data-id="${task.id}" data-points="${task.points}">Aprobar</button>
                        <button class="btn-reject-task bg-red-500 text-white w-full py-2 px-4 rounded-full font-bold hover:bg-red-600 transition-colors" data-id="${task.id}">Rechazar</button>
                    </div>
                `;
                taskEl.querySelector('.btn-approve-task').addEventListener('click', (e) => handleApproveTask(task.id, task.name, parseInt(e.currentTarget.dataset.points, 10)));
                taskEl.querySelector('.btn-reject-task').addEventListener('click', (e) => handleRejectTask(e.currentTarget.dataset.id));
                containers.pendingTasksList.appendChild(taskEl);
            });
        }

        function renderRewardsList() {
            if (!containers.rewardsList) return;
            containers.rewardsList.innerHTML = '';
            if (localRewards.length === 0) {
                containers.rewardsList.innerHTML = '<p class="text-gray-500 text-center">No hay recompensas.</p>';
                return;
            }
            localRewards.sort((a, b) => a.cost - b.cost);

            localRewards.forEach(reward => {
                const canAfford = localTotalPoints >= reward.cost;
                const rewardEl = document.createElement('div');
                rewardEl.className = `p-4 rounded-lg shadow flex justify-between items-center ${canAfford ? 'bg-white' : 'bg-gray-100'}`;
                rewardEl.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg ${canAfford ? 'text-gray-800' : 'text-gray-500'}">${reward.name}</span>
                        <span class="text-sm ${canAfford ? 'text-yellow-600' : 'text-gray-400'}">(${reward.cost} pts)</span>
                    </div>
                    <button class="btn-redeem-reward bg-purple-500 text-white py-2 px-5 rounded-full font-bold transition-colors ${canAfford ? 'hover:bg-purple-600' : 'opacity-50 cursor-not-allowed'}" data-id="${reward.id}" data-cost="${reward.cost}" data-name="${reward.name}" ${canAfford ? '' : 'disabled'}>
                        Canjear
                    </button>
                `;
                if (canAfford) {
                    rewardEl.querySelector('.btn-redeem-reward').addEventListener('click', (e) => {
                        handleRedeemReward(reward.id, reward.name, reward.cost);
                    });
                }
                containers.rewardsList.appendChild(rewardEl);
            });
        }

        function renderRewardsEditList() {
            if (!containers.rewardsEditList) return;
            containers.rewardsEditList.innerHTML = '';
            if (localRewards.length === 0) return;
            const sortedRewards = [...localRewards].sort((a, b) => a.name.localeCompare(b.name));

            sortedRewards.forEach(reward => {
                const rewardEl = document.createElement('div');
                rewardEl.className = 'bg-white p-3 rounded-lg shadow flex justify-between items-center border border-gray-200';
                rewardEl.innerHTML = `
                    <div class="overflow-hidden">
                        <span class="font-semibold text-gray-800 block truncate">${reward.name}</span>
                        <span class="text-xs text-yellow-600">${reward.cost} pts</span>
                    </div>
                    <div class="flex gap-1 shrink-0">
                        <button class="btn-edit-reward text-xl p-2 rounded-full hover:bg-blue-100" data-id="${reward.id}">‚úèÔ∏è</button>
                        <button class="btn-delete-reward text-xl p-2 rounded-full hover:bg-red-100" data-id="${reward.id}">üóëÔ∏è</button>
                    </div>
                `;
                rewardEl.querySelector('.btn-edit-reward').addEventListener('click', () => startEditReward(reward.id, reward.name, reward.cost));
                rewardEl.querySelector('.btn-delete-reward').addEventListener('click', (e) => {
                    handleDeleteReward(e.currentTarget.dataset.id);
                });
                containers.rewardsEditList.appendChild(rewardEl);
            });
        }

        function renderRedeemedRewardsList() {
            if (!containers.redeemedRewardsList) return;
            containers.redeemedRewardsList.innerHTML = '';
            // TODO: Implementar listener y renderizado
            containers.redeemedRewardsList.innerHTML = '<p class="text-gray-500 text-center">Historial de canjes...</p>';
        }

        function renderPenaltiesApplyList() {
            if (!containers.penaltiesApplyList) return;
            containers.penaltiesApplyList.innerHTML = '';
            if (!currentChildId) {
                containers.penaltiesApplyList.innerHTML = '<p class="text-gray-500 text-center">Selecciona un hijo para aplicar penalidad.</p>';
                return;
            }
            if (localPenalties.length === 0) {
                containers.penaltiesApplyList.innerHTML = '<p class="text-gray-500 text-center">No hay penalidades.</p>';
                return;
            }
            localPenalties.sort((a, b) => a.name.localeCompare(b.name));
            localPenalties.forEach(p => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg shadow flex justify-between items-center';
                el.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${p.name}</span>
                        <span class="text-sm text-red-600">(${p.points} pts)</span>
                    </div>
                    <button class="btn-apply-penalty bg-red-500 text-white py-2 px-5 rounded-full font-bold hover:bg-red-600" data-name="${p.name}" data-points="${p.points}">
                        Aplicar
                    </button>
                `;
                el.querySelector('.btn-apply-penalty').addEventListener('click', (e) => {
                    handleApplyPenalty(p.name, p.points);
                });
                containers.penaltiesApplyList.appendChild(el);
            });
        }
        
        function renderPenaltiesEditList() {
            if (!containers.penaltiesEditList) return;
            containers.penaltiesEditList.innerHTML = '';
            if (localPenalties.length === 0) return;
            localPenalties.forEach(p => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg shadow flex justify-between items-center border border-gray-200';
                el.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">${p.name}</span>
                        <span class="text-xs text-red-600">${p.points} pts</span>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn-edit-penalty text-xl p-2 rounded-full hover:bg-blue-100" data-id="${p.id}">‚úèÔ∏è</button>
                        <button class="btn-delete-penalty text-xl p-2 rounded-full hover:bg-red-100" data-id="${p.id}">üóëÔ∏è</button>
                    </div>
                `;
                el.querySelector('.btn-edit-penalty').addEventListener('click', () => startEditPenalty(p.id, p.name, p.points));
                el.querySelector('.btn-delete-penalty').addEventListener('click', (e) => {
                    handleDeletePenalty(e.currentTarget.dataset.id);
                });
                containers.penaltiesEditList.appendChild(el);
            });
        }
        
        function renderPointsHistory() {
            if (!containers.pointsHistoryList) return;
            containers.pointsHistoryList.innerHTML = '';
            if (!currentChildId) return; 
            
            if (localPointsHistory.length === 0) {
                 containers.pointsHistoryList.innerHTML = '<p class="text-gray-500 text-center">A√∫n no hay historial.</p>';
                 return;
            }
            
            localPointsHistory.forEach(item => {
                const el = document.createElement('div');
                const isPositive = item.points > 0;
                el.className = `flex justify-between items-center p-3 rounded-lg ${isPositive ? 'bg-green-50' : 'bg-red-50'}`;
                el.innerHTML = `
                    <span class="font-medium text-gray-700">${item.reason}</span>
                    <span class="font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                        ${isPositive ? '+' : ''}${item.points} pts
                    </span>
                `;
                containers.pointsHistoryList.appendChild(el);
            });
        }
        
        function updatePointsDisplay() {
            const points = localTotalPoints || 0;
            if (elements.totalPointsDisplay) elements.totalPointsDisplay.textContent = `${points}`;
            if (elements.totalPointsHeader) elements.totalPointsHeader.textContent = `${points} Pts`;
            
            if (localUserMode === 'child') {
                renderRewardsList();
            }
        }

        // --- L√≥gica de Edici√≥n (Hijos) ---
        function startEditChild(id, name, gender) {
            currentEditingChildId = id;
            elements.editChildName.value = name;
            document.querySelector(`#form-edit-child input[name="edit-gender"][value="${gender}"]`).checked = true;
            forms['form-edit-child'].classList.remove('hidden');
            forms['form-add-child'].classList.add('hidden');
        }
        function cancelEditChild() {
            currentEditingChildId = null;
            forms['form-edit-child'].classList.add('hidden');
            forms['form-add-child'].classList.remove('hidden');
            forms['form-edit-child'].reset();
        }

        // --- L√≥gica de Edici√≥n (Tareas) ---
        function startEditTask(id, name, points) {
            currentEditingTaskId = id;
            elements.editTaskName.value = name;
            elements.editTaskPoints.value = points;
            forms['form-edit-task'].classList.remove('hidden');
            forms['form-add-task'].classList.add('hidden');
        }
        function cancelEditTask() {
            currentEditingTaskId = null;
            forms['form-edit-task'].classList.add('hidden');
            forms['form-add-task'].classList.remove('hidden');
            forms['form-edit-task'].reset();
        }

        // --- L√≥gica de Edici√≥n (Penalidades) ---
        function startEditPenalty(id, name, points) {
            currentEditingPenaltyId = id;
            elements.editPenaltyName.value = name;
            elements.editPenaltyPoints.value = points;
            forms['form-edit-penalty'].classList.remove('hidden');
            forms['form-add-penalty'].classList.add('hidden');
        }
        function cancelEditPenalty() {
            currentEditingPenaltyId = null;
            forms['form-edit-penalty'].classList.add('hidden');
            forms['form-add-penalty'].classList.remove('hidden');
            forms['form-edit-penalty'].reset();
        }

        // --- L√≥gica de Edici√≥n (Recompensas) ---
        function startEditReward(id, name, cost) {
            currentEditingRewardId = id;
            elements.editRewardName.value = name;
            elements.editRewardCost.value = cost;
            forms['form-edit-reward'].classList.remove('hidden');
            forms['form-add-reward'].classList.add('hidden');
        }
        function cancelEditReward() {
            currentEditingRewardId = null;
            forms['form-edit-reward'].classList.add('hidden');
            forms['form-add-reward'].classList.remove('hidden');
            forms['form-edit-reward'].reset();
        }


        // --- Handlers (Firebase) ---

        // Funci√≥n para a√±adir al historial de puntos (Global)
        async function addPointsHistory(childId, childName, reason, points) {
            if (!pointsHistoryRef) return;
            try {
                await addDoc(pointsHistoryRef, {
                    childId,
                    childName,
                    reason,
                    points,
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                console.error("Error al guardar historial de puntos:", err);
            }
        }

        // Gesti√≥n de Hijos
        async function handleAddChild(e) {
            e.preventDefault();
            if (!childrenRef) return;
            const name = e.target['child-name'].value;
            const gender = e.target['gender'].value;
            if (!name || !gender) return;
            showLoading(true);
            try { 
                await addDoc(childrenRef, { name, gender, totalPoints: 0 }); 
                e.target.reset(); 
            } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        async function handleEditChildSubmit(e) {
            e.preventDefault();
            if (!currentEditingChildId || !childrenRef) return;
            const name = elements.editChildName.value;
            const gender = e.target['edit-gender'].value;
            if (!name || !gender) return;
            showLoading(true);
            try {
                await updateDoc(doc(db, childrenRef.path, currentEditingChildId), { name, gender });
                cancelEditChild();
            } catch (err) { console.error(err); }
            finally { showLoading(false); }
        }
        async function handleDeleteChild(childId, childName) {
            if (!childrenRef) return;
            showLoading(true);
            try { 
                await deleteDoc(doc(db, childrenRef.path, childId)); 
            } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }

        // Gesti√≥n de Tareas (por hijo) - AHORA BATCH
        async function handleAddTask(e) {
            e.preventDefault();
            if (!tasksRef) {
                return;
            }
            
            const name = e.target['task-name'].value;
            const points = parseInt(e.target['task-points'].value, 10);
            
            // Obtener hijos seleccionados
            const checkboxes = document.querySelectorAll('input[name="child-assign"]:checked');
            const selectedChildIds = Array.from(checkboxes).map(cb => cb.value);

            if (!name || points <= 0) {
                alert("Por favor ingresa nombre y puntos v√°lidos.");
                return;
            }
            
            showLoading(true);
            try { 
                const batch = writeBatch(db);
                
                selectedChildIds.forEach(childId => {
                    const newTaskRef = doc(tasksRef); // Auto-ID
                    batch.set(newTaskRef, { 
                        name, 
                        points, 
                        childId: childId 
                    });
                });

                await batch.commit();
                console.log('handleAddTask: Tareas guardadas con √©xito para:', selectedChildIds); 
                e.target.reset(); 
                // Resetear checkboxes
                document.querySelectorAll('input[name="child-assign"]').forEach(cb => cb.checked = false);
            } 
            catch (err) { console.error("Error al guardar tarea:", err); } 
            finally { showLoading(false); }
        }

        async function handleEditTaskSubmit(e) {
            e.preventDefault();
            if (!currentEditingTaskId || !tasksRef) return;
            const name = elements.editTaskName.value;
            const points = parseInt(elements.editTaskPoints.value, 10);
            showLoading(true);
            try {
                await updateDoc(doc(db, tasksRef.path, currentEditingTaskId), { name, points });
                cancelEditTask();
            } catch (err) { console.error(err); }
            finally { showLoading(false); }
        }
        async function handleDeleteTask(taskId) {
            if (!tasksRef) return;
            showLoading(true);
            try { await deleteDoc(doc(db, tasksRef.path, taskId)); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }

        // Gesti√≥n de Recompensas (Global)
        async function handleAddReward(e) {
            e.preventDefault();
            if (!rewardsRef) return;
            const name = e.target['reward-name'].value;
            const cost = parseInt(e.target['reward-cost'].value, 10);
            if (!name || cost <= 0) return;
            showLoading(true);
            try { await addDoc(rewardsRef, { name, cost }); e.target.reset(); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        async function handleEditRewardSubmit(e) {
            e.preventDefault();
            if (!currentEditingRewardId || !rewardsRef) return;
            const name = elements.editRewardName.value;
            const cost = parseInt(elements.editRewardCost.value, 10);
            showLoading(true);
            try {
                await updateDoc(doc(db, rewardsRef.path, currentEditingRewardId), { name, cost });
                cancelEditReward();
            } catch (err) { console.error(err); }
            finally { showLoading(false); }
        }
        async function handleDeleteReward(id) {
            if (!rewardsRef) return;
            showLoading(true);
            try { await deleteDoc(doc(db, rewardsRef.path, id)); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        
        // Gesti√≥n de Penalidades (Global)
         async function handleAddPenalty(e) {
            e.preventDefault();
            if (!penaltiesRef) return;
            const name = e.target['penalty-name'].value;
            const points = parseInt(e.target['penalty-points'].value, 10);
            if (!name || points <= 0) return;
            showLoading(true);
            try { await addDoc(penaltiesRef, { name, points: Math.abs(points) }); e.target.reset(); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        async function handleEditPenaltySubmit(e) {
            e.preventDefault();
            if (!currentEditingPenaltyId || !penaltiesRef) return;
            const name = elements.editPenaltyName.value;
            const points = parseInt(elements.editPenaltyPoints.value, 10);
            showLoading(true);
            try {
                await updateDoc(doc(db, penaltiesRef.path, currentEditingPenaltyId), { name, points: Math.abs(points) });
                cancelEditPenalty();
            } catch (err) { console.error(err); }
            finally { showLoading(false); }
        }
        async function handleDeletePenalty(id) {
            if (!penaltiesRef) return;
            showLoading(true);
            try { await deleteDoc(doc(db, penaltiesRef.path, id)); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        
        // --- Handlers de Flujo de Puntos (Por Hijo) ---
        
        async function handleCompleteTask(taskId, name, points) {
            if (!currentChildId || !pendingTasksRef) return;
            showLoading(true);
            try { 
                await addDoc(pendingTasksRef, { 
                    taskId, 
                    name, 
                    points, 
                    requestedAt: serverTimestamp(),
                    childId: currentChildId 
                }); 
            } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        
        async function handleApproveTask(id, name, points) { // id = pendingTaskDocId
            if (!currentChildId || !pendingTasksRef || !childrenRef || !tasksCooldownRef) return;
            showLoading(true);
            try {
                const childDocRef = doc(db, childrenRef.path, currentChildId);
                
                const pendingTask = localPendingTasks.find(pt => pt.id === id); 
                if (!pendingTask) {
                    console.error("No se encontr√≥ la tarea pendiente para aprobar:", id);
                    showLoading(false);
                    return;
                }
                
                const batch = writeBatch(db);
                batch.update(childDocRef, { totalPoints: increment(points) }); 
                batch.delete(doc(db, pendingTasksRef.path, id)); 
                
                const cooldownDocRef = doc(tasksCooldownRef); 
                batch.set(cooldownDocRef, {
                    childId: currentChildId,
                    taskId: pendingTask.taskId, 
                    date: getLocalDateString() 
                });

                await batch.commit();

                // A√±adir al historial
                await addPointsHistory(currentChildId, currentChildName, `Tarea: ${name}`, points);

            } catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        
        async function handleRejectTask(id) {
            if (!pendingTasksRef) return;
            showLoading(true);
            try { await deleteDoc(doc(db, pendingTasksRef.path, id)); } 
            catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }
        
        async function handleRedeemReward(id, name, cost) {
            if (localTotalPoints < cost || !currentChildId || !childrenRef || !redeemedRewardsRef) return;
            showLoading(true);
            try {
                const childDocRef = doc(db, childrenRef.path, currentChildId);
                
                const batch = writeBatch(db);
                batch.update(childDocRef, { totalPoints: increment(-cost) }); 
                
                const newRef = doc(collection(db, redeemedRewardsRef.path));
                batch.set(newRef, { childId: currentChildId, childName: currentChildName, name, cost, redeemedAt: serverTimestamp() });
                await batch.commit();
                
                // A√±adir al historial
                await addPointsHistory(currentChildId, currentChildName, `Canje: ${name}`, -cost);
                
            } catch (err) { console.error(err); } 
            finally { showLoading(false); }
        }

        async function handleApplyPenalty(name, points) {
            if (!currentChildId || !childrenRef) return;
            showLoading(true);
            try {
                const childDocRef = doc(db, childrenRef.path, currentChildId);
                
                const pointsToDecrement = -Math.abs(points);
                await updateDoc(childDocRef, { totalPoints: increment(pointsToDecrement) }); 
                
                // A√±adir al historial
                await addPointsHistory(currentChildId, currentChildName, `Penalidad: ${name}`, pointsToDecrement);

            } catch (err) {
                console.error(err);
            } finally {
                showLoading(false);
            }
        }


        // --- DEFINICI√ìN DE RUTAS DE FIREBASE (Multi-Familia) ---

        // Rutas globales que se definen una vez que el admin se loguea
        function setupGlobalFirestoreReferences(adminUserId) {
            if (!adminUserId) return;
            
            // Correcci√≥n: La "caja fuerte" es el DOCUMENTO del usuario (familia)
            familyDocRef = doc(db, 'familias', adminUserId);
            
            // Las colecciones (hijos, recompensas...) cuelgan DEBAJO de ese documento
            childrenRef = collection(db, familyDocRef.path, 'children');
            rewardsRef = collection(db, familyDocRef.path, 'rewards');
            penaltiesRef = collection(db, familyDocRef.path, 'penalties');
            redeemedRewardsRef = collection(db, familyDocRef.path, 'redeemedRewards');
            pointsHistoryRef = collection(db, familyDocRef.path, 'pointsHistory');
            
            // Las tareas y pendientes tambi√©n son globales de la familia
            tasksRef = collection(db, familyDocRef.path, 'tasks');
            pendingTasksRef = collection(db, familyDocRef.path, 'pendingTasks');
            tasksCooldownRef = collection(db, familyDocRef.path, 'tasksCooldown'); // <-- NUEVO
        }

        // Rutas que dependen del hijo seleccionado (YA NO ES NECESARIO)
        function setupChildFirestoreReferences(childId) {
            // Ya no necesitamos definir referencias aqu√≠, 
            // tasksRef y pendingTasksRef son globales (de la familia)
            // Filtraremos por 'childId' en los listeners
            if (!childId || !childrenRef) {
                console.error("¬°No se puede definir la ruta sin childId o childrenRef!");
                return;
            }
        }

        // --- Listeners de DB ---
        function setupGlobalFirestoreListeners() {
            if (!currentUserId || !familyDocRef) return;
            
            // Limpia listeners globales anteriores
            if (familyDocListener) familyDocListener();
            if (childrenListener) childrenListener();
            if (rewardsListener) rewardsListener();
            if (penaltiesListener) penaltiesListener();
            if (redeemedRewardsListener) redeemedRewardsListener();

            // Listener para el documento de familia (reseteo)
            familyDocListener = onSnapshot(familyDocRef, (doc) => {
                if (doc.exists()) {
                    localLastReset = doc.data().lastReset || null;
                    
                    // *** NUEVO: LEER PIN DEL DOCUMENTO ***
                    if (doc.data().pin) {
                        localAdminPin = doc.data().pin;
                    }
                } else { 
                    const todayStr = getLocalDateString(); 
                    // Guardar PIN default al crear
                    setDoc(familyDocRef, { 
                        adminId: currentUserId, 
                        lastReset: todayStr,
                        pin: DEFAULT_PIN 
                    });
                    localLastReset = todayStr;
                }
                
                // Solo chequear reseteo si ya cargaron los hijos
                if (localChildren.length > 0 || hasInitialDataLoaded) {
                     checkDailyReset(); 
                }
                
            }, (error) => console.error("Error en listener de familyDocRef:", error));

            // Listener para Hijos
            childrenListener = onSnapshot(childrenRef, (s) => {
                localChildren = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderChildLoginList();
                renderChildrenEditList();
                if(localUserMode === 'admin') {
                    populateAdminSelects();
                    renderChildCheckboxes(); // Update checkboxes when children list changes
                }
                
                // Si estoy logueado como hijo, actualiza mis puntos
                if(localUserMode === 'child' && currentChildId) {
                    const myData = localChildren.find(c => c.id === currentChildId);
                    if (myData) {
                        localTotalPoints = myData.totalPoints;
                        
                        // *** ACTUALIZACI√ìN DE NOMBRE EN RESTAURACI√ìN DE SESI√ìN ***
                        // Si restauramos sesi√≥n, no ten√≠amos el nombre. Aqu√≠ lo actualizamos.
                        if (currentChildName === "Cargando..." || currentChildName !== myData.name) {
                            currentChildName = myData.name;
                            const genderEmoji = myData.gender === 'boy' ? 'üë¶' : 'üëß';
                            if (elements.childNameHeader) {
                                elements.childNameHeader.textContent = `Hola, ${myData.name}! ${genderEmoji}`;
                            }
                        }

                        updatePointsDisplay();
                    } else {
                        logout(); // Me han borrado
                    }
                }
                
                // Carga inicial de datos de la familia (si es necesario)
                if (!hasInitialDataLoaded) {
                    hasInitialDataLoaded = true; 
                    checkDailyReset(); // Ahora s√≠ podemos chequear el reseteo
                }

            }, (error) => console.error("Error en listener de childrenRef:", error));

            // Listeners Globales (Recompensas y Penalidades de la familia)
            rewardsListener = onSnapshot(rewardsRef, (s) => {
                localRewards = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderRewardsList();
                renderRewardsEditList(); 
            }, (error) => console.error("Error en listener de rewardsRef:", error));

            penaltiesListener = onSnapshot(penaltiesRef, (s) => {
                localPenalties = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderPenaltiesApplyList();
                renderPenaltiesEditList();
            }, (error) => console.error("Error en listener de penaltiesRef:", error));
            
            // TODO: Listener para canjeados
            // redeemedRewardsListener = onSnapshot(redeemedRewardsRef, ...);
            
            // Listener global de tareas (para el resumen)
            const allTasksQuery = query(tasksRef);
            allTasksListener = onSnapshot(allTasksQuery, (s) => {
                localFamilyTasks = s.docs.map(d => ({ id: d.id, ...d.data() }));
                if(localUserMode === 'admin') renderAllTasksSummary();
            });
        }

        function setupChildFirestoreListeners() {
            // Limpia listeners de hijo anteriores
            if(tasksListener) tasksListener();
            if(pendingTasksListener) pendingTasksListener();
            if(pointsHistoryListener) pointsHistoryListener();
            if(tasksCooldownListener) tasksCooldownListener(); 

            console.log('setupChildFirestoreListeners: Configurando listeners para childId:', currentChildId); 

            if (!currentChildId || !tasksRef || !pendingTasksRef || !pointsHistoryRef || !tasksCooldownRef) { 
                console.error('setupChildFirestoreListeners: FALTAN REFERENCIAS, no se configuran listeners.', { currentChildId, tasksRef, pendingTasksRef, pointsHistoryRef, tasksCooldownRef });
                return;
            }

            // Listener para Tareas del hijo (filtradas)
            const tasksQuery = query(tasksRef, where("childId", "==", currentChildId));
            tasksListener = onSnapshot(tasksQuery, (s) => {
                console.log('tasksListener: Tareas recibidas:', s.docs.length); 
                localTasks = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTasksList();
                // renderActiveTasksEditList() ELIMINADO
            }, (error) => console.error("Error GRAVE en tasksListener:", error)); 

            // Listener para Pendientes del hijo (filtradas)
            const pendingQuery = query(pendingTasksRef, where("childId", "==", currentChildId));
            pendingTasksListener = onSnapshot(pendingQuery, (s) => {
                localPendingTasks = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTasksList(); // Actualiza los 'checks'
                if(localUserMode === 'admin') renderPendingTasksList();
            }, (error) => console.error("Error en listener de childPendingTasksRef:", error));

            // *** SECCI√ìN MODIFICADA ***
            // Listener para Historial de Puntos del hijo (filtradas)
            // Quitamos orderBy y limit para evitar errores de √≠ndice y lo hacemos en JS
            const historyQuery = query(pointsHistoryRef, where("childId", "==", currentChildId));
            pointsHistoryListener = onSnapshot(historyQuery, (s) => {
                
                let historyData = s.docs.map(d => d.data());
                
                // Ordenamos en JavaScript (descendente)
                historyData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                // Limitamos en JavaScript
                localPointsHistory = historyData.slice(0, 20); // Tomamos solo los primeros 20

                renderPointsHistory();

            }, (error) => {
                console.error("Error en listener de pointsHistoryRef:", error);
            });
            // *** FIN DE SECCI√ìN MODIFICADA ***

            // *** NUEVO LISTENER: Tareas en Cooldown (completadas hoy) ***
            const todayStr = getLocalDateString();
            const cooldownQuery = query(tasksCooldownRef, 
                                    where("childId", "==", currentChildId), 
                                    where("date", "==", todayStr)
                                  );
            tasksCooldownListener = onSnapshot(cooldownQuery, (s) => {
                console.log('tasksCooldownListener: Tareas en cooldown recibidas:', s.docs.length);
                localTasksCooldown = s.docs.map(d => d.data());
                renderTasksList(); // Actualiza la lista de tareas para ocultar las completadas
            }, (error) => console.error("Error GRAVE en tasksCooldownListener:", error));
        }

    </script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader { animation: spin 1s linear infinite; }
        .main-menu-button {
            @apply w-full text-white font-bold rounded-2xl shadow-lg
                   flex flex-col justify-center items-center transition-transform 
                   duration-200 ease-in-out transform hover:scale-105 gap-2 px-4 py-6;
        }
        body { font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div class="container mx-auto max-w-lg p-4 min-h-screen relative">
        <!-- Overlay de Carga -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex justify-center items-center z-50 hidden">
            <div class="loader border-4 border-blue-200 border-t-blue-600 rounded-full w-12 h-12"></div>
        </div>

        <!-- === P√°gina de Login === -->
        <div id="page-login" class="">
             <header class="text-center mb-12 mt-16">
                 <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight">App de Recompensas</h1>
                 <p class="text-xl text-gray-600 mt-4">Inicia sesi√≥n o crea una cuenta</p>
             </header>
            <div class="space-y-4 max-w-sm mx-auto">
                <button id="btn-login-google" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors shadow-sm">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.712,34.464,44,28.098,44,20C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    <span class="text-lg font-medium">Continuar con Google</span>
                </button>
                
                <div class="flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="mx-4 text-gray-500 text-sm">o</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <button id="btn-show-email-login" class="w-full bg-gray-700 text-white p-3 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-800 transition-colors shadow-sm">
                    <span class="text-lg font-medium">Continuar con Email</span>
                </button>

                <!-- Formulario Login Email -->
                <form id="form-email-login" class="hidden space-y-4 pt-4 border-t border-gray-200">
                    <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                    <input type="password" name="password" placeholder="Contrase√±a" class="w-full p-3 border rounded-lg" required>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors">Iniciar Sesi√≥n</button>
                    <p class="text-center text-sm">
                        <a href="#" id="btn-show-email-register" class="text-blue-600 hover:underline">No tengo cuenta (Crear una)</a>
                    </p>
                </form>

                <!-- Formulario Registro Email -->
                <form id="form-email-register" class="hidden space-y-4 pt-4 border-t border-gray-200">
                    <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                    <input type="password" name="password" placeholder="Contrase√±a (m√≠n. 6 caracteres)" class="w-full p-3 border rounded-lg" required>
                    <p id="register-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-colors">Crear Cuenta</button>
                    <p class="text-center text-sm">
                        <a href="#" class="text-blue-600 hover:underline" onclick="event.preventDefault(); showLoginForm('login');">Ya tengo cuenta (Iniciar Sesi√≥n)</a>
                    </p>
                </form>
            </div>
        </div>
        
        <!-- === Modal de PIN (para salir de modo hijo) === -->
        <div id="page-pin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-40 p-4">
            <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Modo Admin</h2>
                <p class="text-center text-gray-600 mb-6">Ingresa el PIN para volver al panel de admin.</p>
                <form id="form-pin" class="space-y-4">
                    <input type="password" id="pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="4" class="w-full p-4 text-3xl text-center tracking-widest border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" required>
                    <p id="pin-error" class="text-red-500 text-center hidden">PIN incorrecto. Intenta de nuevo.</p>
                    <button type="submit" id="btn-pin-validate" class="w-full bg-blue-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-600 transition-colors">Entrar</button>
                    <button type="button" id="btn-pin-cancel" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-bold hover:bg-gray-300 transition-colors">Cancelar</button>
                </form>
            </div>
        </div>

        <!-- === Modal de Cambio de PIN === -->
        <div id="page-change-pin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-40 p-4">
            <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Cambiar PIN</h2>
                <p class="text-center text-gray-600 mb-6">Ingresa el nuevo PIN de 4 d√≠gitos.</p>
                <form id="form-change-pin" class="space-y-4">
                    <input type="password" id="new-pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="4" placeholder="Nuevo PIN" class="w-full p-4 text-3xl text-center tracking-widest border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" required>
                    <input type="password" id="confirm-pin-input" pattern="[0-9]*" inputmode="numeric" maxlength="4" placeholder="Confirmar PIN" class="w-full p-4 text-3xl text-center tracking-widest border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" required>
                    <p id="change-pin-error" class="text-red-500 text-center hidden"></p>
                    <button type="submit" class="w-full bg-blue-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-blue-600 transition-colors">Guardar Nuevo PIN</button>
                    <button type="button" id="btn-change-pin-cancel" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-bold hover:bg-gray-300 transition-colors">Cancelar</button>
                </form>
            </div>
        </div>

        <!-- === P√°gina Principal (Admin o Selecci√≥n de Hijo) === -->
        <div id="page-main" class="hidden">
            <header class="flex justify-between items-center mb-8 mt-4">
                <div class="text-left">
                    <!-- Vista Admin -->
                    <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight admin-only">Panel Admin</h1>
                    
                    <!-- Vista Hijo -->
                    <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight child-only" id="child-name-header">Hola!</h1>
                    <div id="total-points-header" class="text-2xl font-bold text-yellow-500 mt-1 child-only">...</div>
                </div>
                <!-- Bot√≥n de Salir (Admin) -->
                <div class="flex gap-2 admin-only">
                    <button id="btn-change-pin" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold hover:bg-blue-200">üîë PIN</button>
                    <button id="btn-logout" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-bold hover:bg-gray-300">Salir</button>
                </div>
                
                <!-- *** NUEVO BOT√ìN: Salir a Admin (Hijo) *** -->
                <button id="btn-exit-child-mode" class="child-only text-3xl p-2 rounded-full hover:bg-gray-200 hidden">üîí</button>
            </header>

            <!-- Panel de Selecci√≥n de Hijo (Admin) -->
            <div class="admin-only">
                <p class="text-xl text-gray-600 mt-4 mb-6">¬øQu√© quieres hacer?</p>
                <div class="space-y-4 mb-8">
                    <!-- Lista de hijos para loguear -->
                    <div id="child-login-list" class="space-y-4"></div>
                </div>
                <div class="flex items-center mb-8">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="mx-4 text-gray-500 text-sm">PANEL ADMIN</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
            </div>

            <!-- Men√∫ Principal -->
            <nav class="grid grid-cols-2 gap-4">
                <!-- Botones de Hijo -->
                <button id="btn-tasks" class="main-menu-button bg-blue-500 child-only">
                    <img src="https://static.wixstatic.com/media/63d26f_d51dde8ebc2448e4b7b9024695d228dc~mv2.png" alt="Tareas" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/3B82F6/FFFFFF?text=Tareas'">
                    <span class="text-lg text-center">Tareas Diarias</span>
                </button>
                <button id="btn-points" class="main-menu-button bg-green-500 child-only">
                    <img src="https://static.wixstatic.com/media/63d26f_be54b83d9e814163a2855dad5df2ba90~mv2.png" alt="Puntos" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/22C55E/FFFFFF?text=Puntos'">
                    <span class="text-lg text-center">Puntos</span>
                </button>
                <button id="btn-redeem" class="main-menu-button bg-purple-500 child-only">
                    <img src="https://static.wixstatic.com/media/63d26f_127c592fd4f142779dea0d23bc6813cb~mv2.png" alt="Canjear" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/A855F7/FFFFFF?text=Canjear'">
                    <span class="text-lg text-center">Canjear Puntos</span>
                </button>
                <button id="btn-redeemed-list" class="main-menu-button bg-pink-500 child-only">
                    <img src="https://static.wixstatic.com/media/63d26f_4005beb44e7846c3bf7d343f28aa1552~mv2.png" alt="Historial" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/EC4899/FFFFFF?text=Canjes'">
                    <span class="text-lg text-center">Lista de Canjes</span>
                </button>

                <!-- Botones de Admin -->
                <button id="btn-manage-children" class="main-menu-button bg-cyan-500 admin-only">
                    <span class="text-5xl">üë´</span>
                    <span class="text-lg text-center">Gestionar Hijos</span>
                </button>
                <button id="btn-evaluate" class="main-menu-button bg-yellow-500 text-yellow-900 admin-only">
                    <img src="https://static.wixstatic.com/media/63d26f_1dddc78199a14d2e85b10b90ec28e8e0~mv2.png" alt="Evaluar" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/EAB308/FFFFFF?text=Evaluar'">
                    <span class="text-lg text-center">Evaluar Tareas</span>
                </button>
                 <button id="btn-penalties" class="main-menu-button bg-red-600 admin-only">
                    <img src="https://static.wixstatic.com/media/63d26f_dca1939b25bb471f92cbeb25d4e578bd~mv2.png" alt="Penalidad" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/DC2626/FFFFFF?text=Penalidad'">
                    <span class="text-lg text-center">Penalidad</span>
                </button>
                <button id="btn-manage-tasks" class="main-menu-button bg-blue-500 admin-only">
                     <img src="https://static.wixstatic.com/media/63d26f_d51dde8ebc2448e4b7b9024695d228dc~mv2.png" alt="Tareas" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/3B82F6/FFFFFF?text=Tareas'">
                    <span class="text-lg text-center">Gestionar Tareas</span>
                </button>
                <button class="main-menu-button bg-purple-500 admin-only" onclick="document.getElementById('page-redeem').classList.remove('hidden'); document.getElementById('page-main').classList.add('hidden');">
                    <img src="https://static.wixstatic.com/media/63d26f_127c592fd4f142779dea0d23bc6813cb~mv2.png" alt="Canjear" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/A855F7/FFFFFF?text=Canjear'">
                    <span class="text-lg text-center">Gestionar Tienda</span>
                </button>
                <button class="main-menu-button bg-pink-500 admin-only" onclick="document.getElementById('page-redeemed-list').classList.remove('hidden'); document.getElementById('page-main').classList.add('hidden');">
                    <img src="https://static.wixstatic.com/media/63d26f_4005beb44e7846c3bf7d343f28aa1552~mv2.png" alt="Historial" class="w-16 h-16 object-contain mx-auto" onerror="this.src='https://placehold.co/64x64/EC4899/FFFFFF?text=Canjes'">
                    <span class="text-lg text-center">Ver Canjes Global</span>
                </button>
            </nav>
        </div>
        
        <!-- === P√°gina Gestionar Hijos (Admin) === -->
        <div id="page-manage-children" class="hidden admin-only">
            <header class="flex items-center mb-6">
                <button class="btn-back text-cyan-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-cyan-600 ml-4">Gestionar Hijos</h1>
            </header>

            <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">A√±adir Hijo</h2>
                <form id="form-add-child" class="space-y-3">
                    <input type="text" name="child-name" placeholder="Nombre del hijo" class="w-full p-3 border rounded-lg" required>
                    <div class="flex justify-around p-2 bg-gray-100 rounded-lg">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="gender" value="girl" class="text-pink-500 focus:ring-pink-400" checked>
                            <span class="text-3xl">üëß</span> Ni√±a
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="gender" value="boy" class="text-blue-500 focus:ring-blue-400">
                            <span class="text-3xl">üë¶</span> Ni√±o
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-cyan-500 text-white p-3 rounded-lg font-bold">Guardar Hijo</button>
                </form>
                
                <form id="form-edit-child" class="hidden space-y-3 bg-cyan-50 p-3 rounded-lg mt-3 border border-cyan-200">
                    <p class="font-bold text-cyan-800">Editando Hijo:</p>
                    <input type="text" id="edit-child-name" class="w-full p-3 border rounded-lg" required>
                    <div id="edit-child-gender" class="flex justify-around p-2 bg-gray-100 rounded-lg">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="edit-gender" value="girl" class="text-pink-500 focus:ring-pink-400">
                            <span class="text-3xl">üëß</span> Ni√±a
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="edit-gender" value="boy" class="text-blue-500 focus:ring-blue-400">
                            <span class="text-3xl">üë¶</span> Ni√±o
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-bold">Actualizar</button>
                        <button type="button" id="btn-edit-child-cancel" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-bold">Cancelar</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-20">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Lista de Hijos</h2>
                <div id="children-edit-list-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>

        <!-- === Tareas Diarias (Hijo) === -->
        <div id="page-tasks" class="hidden child-only">
            <header class="flex items-center mb-6">
                <button class="btn-back text-blue-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-blue-600 ml-4">Tareas Diarias</h1>
            </header>
            <div id="tasks-list-container" class="space-y-3 pb-20"></div>
        </div>

        <!-- === Puntos (Hijo) === -->
        <div id="page-points" class="hidden child-only">
            <header class="flex items-center mb-6">
                <button class="btn-back text-green-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-green-600 ml-4">Mis Puntos</h1>
            </header>
            <div class="flex flex-col items-center justify-center p-10 bg-white rounded-3xl shadow-xl border-4 border-green-100 mb-6">
                <span class="text-8xl font-black text-green-500" id="total-points-display">0</span>
                <span class="text-2xl text-green-700 font-bold mt-2">PUNTOS TOTALES</span>
            </div>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial Reciente</h2>
            <div id="points-history-list" class="space-y-2 pb-20">
                <!-- Historial se inserta aqu√≠ -->
            </div>
        </div>

        <!-- === Evaluar Tareas (Admin) === -->
        <div id="page-evaluate" class="hidden admin-only">
            <header class="flex items-center mb-6">
                <button class="btn-back text-yellow-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-yellow-600 ml-4">Evaluar Tareas</h1>
            </header>
            
            <div class="mb-6">
                <label for="child-select-evaluate" class="block text-sm font-medium text-gray-700 mb-2">Selecciona un hijo:</label>
                <select id="child-select-evaluate" class="w-full p-3 border rounded-lg"></select>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Pendientes de Aprobar</h2>
                <div id="pending-tasks-list-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- === Gestionar Tareas (Admin) === -->
        <div id="page-manage-tasks" class="hidden admin-only">
             <header class="flex items-center mb-6">
                <button class="btn-back text-blue-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-blue-600 ml-4">Gestionar Tareas</h1>
            </header>

            <div class="bg-white p-4 rounded-xl shadow-md mb-6 admin-only">
                <h2 class="text-xl font-bold text-gray-800 mb-4" id="add-task-title">Crear Nueva Tarea</h2>
                <form id="form-add-task" class="space-y-4">
                    <input type="text" id="task-name" name="task-name" placeholder="Nombre de la tarea" class="w-full p-3 border rounded-lg" required>
                    <input type="number" id="task-points" name="task-points" placeholder="Puntos" class="w-full p-3 border rounded-lg" required>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">Asignar a:</label>
                        <div id="task-assignment-checkboxes" class="grid grid-cols-2 gap-2">
                            <!-- Checkboxes populated by JS -->
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="submit" id="add-task-submit-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold">Crear y Asignar</button>
                        <div id="edit-task-cancel-container" class="hidden w-full">
                            <button type="button" id="btn-cancel-edit-global-task" class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-bold">Cancelar</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- NUEVA SECCI√ìN DE RESUMEN GLOBAL -->
            <div class="mb-6 border-t-2 border-gray-200 pt-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen de Tareas Asignadas</h2>
                <div id="global-tasks-summary" class="space-y-2">
                    <!-- Resumen de tareas -->
                </div>
                 <!-- Bot√≥n de Guardar Cambios Globales -->
                <button id="btn-save-global-tasks" class="hidden w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <span>üíæ</span> Guardar Cambios
                </button>
            </div>
        </div>

        <!-- === Tienda (Hijo y Admin) === -->
        <div id="page-redeem" class="hidden">
            <header class="flex items-center mb-6">
                <button class="btn-back text-purple-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-purple-600 ml-4">Tienda</h1>
            </header>
            <div id="rewards-list-container" class="space-y-3 mb-8 child-only"></div>
            
            <!-- SECCI√ìN ADMIN PARA A√ëADIR/EDITAR RECOMPENSAS -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-6 admin-only">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Nueva Recompensa (Global)</h2>
                <form id="form-add-reward" class="space-y-3">
                    <input type="text" id="reward-name" name="reward-name" placeholder="Nombre del premio" class="w-full p-3 border rounded-lg" required>
                    <input type="number" id="reward-cost" name="reward-cost" placeholder="Costo" class="w-full p-3 border rounded-lg" required>
                    <button type="submit" class="w-full bg-purple-500 text-white p-3 rounded-lg font-bold">A√±adir</button>
                </form>

                <form id="form-edit-reward" class="hidden space-y-3 bg-blue-50 p-3 rounded-lg mt-3 border border-blue-200">
                    <p class="font-bold text-blue-800">Editando Recompensa:</p>
                    <input type="text" id="edit-reward-name" class="w-full p-3 border rounded-lg" required>
                    <input type="number" id="edit-reward-cost" class="w-full p-3 border rounded-lg" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-bold">Actualizar</button>
                        <button type="button" id="btn-edit-reward-cancel" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-bold">Cancelar</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-20 admin-only">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Administrar Recompensas (Global)</h2>
                <div id="rewards-edit-list-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

        </div>

        <!-- === Historial (Hijo y Admin) === -->
        <div id="page-redeemed-list" class="hidden">
            <header class="flex items-center mb-6">
                <button class="btn-back text-pink-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-pink-600 ml-4">Historial de Canjes</h1>
            </header>
            <div id="redeemed-rewards-list-container" class="space-y-3 pb-20"></div>
        </div>

        <!-- === Penalidades (Admin) === -->
        <div id="page-penalties" class="hidden admin-only">
            <header class="flex items-center mb-6">
                <button class="btn-back text-red-600 font-bold text-xl">‚¨Ö</button>
                <h1 class="text-3xl font-bold text-red-600 ml-4">Penalidad</h1>
            </header>
            
            <div class="mb-6">
                <label for="child-select-penalties" class="block text-sm font-medium text-gray-700 mb-2">Selecciona un hijo:</label>
                <select id="child-select-penalties" class="w-full p-3 border rounded-lg"></select>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Aplicar Penalidad</h2>
                <div id="penalties-apply-list-container" class="space-y-3"></div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-6 admin-only">
                <h2 class="text-xl font-bold text-gray-800 mb-4">A√±adir Penalidad (Global)</h2>
                <form id="form-add-penalty" class="space-y-3">
                    <input type="text" id="penalty-name" name="penalty-name" placeholder="Nombre de la penalidad" class="w-full p-3 border rounded-lg" required>
                    <input type="number" id="penalty-points" name="penalty-points" placeholder="Puntos (ej: 150)" class="w-full p-3 border rounded-lg" required>
                    <button type="submit" class="w-full bg-red-500 text-white p-3 rounded-lg font-bold">Guardar</button>
                </form>
                
                <form id="form-edit-penalty" class="hidden space-y-3 bg-red-50 p-3 rounded-lg mt-3 border border-red-200">
                    <p class="font-bold text-red-800">Editando Penalidad:</p>
                    <input type="text" id="edit-penalty-name" class="w-full p-3 border rounded-lg" required>
                    <input type="number" id="edit-penalty-points" class="w-full p-3 border rounded-lg" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-bold">Actualizar</button>
                        <button type="button" id="btn-edit-penalty-cancel" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-bold">Cancelar</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md mb-20 admin-only">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Administrar Penalidades (Global)</h2>
                <div id="penalties-edit-list-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>

    </div>
</body>
</html>
